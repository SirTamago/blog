(()=>{let e=false,t=false,n=false;let l;const s=config.root+"search.json";const r=getElement("#search-input");const o=getElement("nav");const i=config.search.activeHolder;const a=config.search.blurHolder;const c=config.search.noResult;const u=getElement(".search-popup");function d(){t=true;fetch(s).then((e=>e.text())).then((t=>{e=true;l=JSON.parse(t);if(n===true){E()}})).catch((()=>t=false))}if(config.search.preload){d()}function h(e,t,n){let l=e.length;if(l===0)return[];let s=0;let r=[];let o=[];if(!n){t=t.toLowerCase();e=e.toLowerCase()}while((r=t.indexOf(e,s))>-1){o.push({position:r,word:e});s=r+l}return o}function f(e,t,n,l){let s=n[n.length-1];let r=s.position;let o=s.word;let i=[];let a=0;while(r+o.length<=t&&n.length!==0){if(o===l){a++}i.push({position:r,length:o.length});let e=r+o.length;n.pop();while(n.length!==0){s=n[n.length-1];r=s.position;o=s.word;if(e>r){n.pop()}else{break}}}return{hits:i,start:e,end:t,TextCount:a}}function g(e,t){let n="";let l=t.start;t.hits.forEach((t=>{n+=e.substring(l,t.position);let s=t.position+t.length;n+=`<nobr class="search-keyword">${e.substring(t.position,s)}</nobr>`;l=s}));n+=e.substring(l,t.end);return n}function p(){getElement("#search-result").innerHTML='<div id="loading"><div><p>Loading...</p></div></div>'}function m(){if(document.querySelector(".up")&&document.querySelector(".closed")){getElement(".navBtn").classList.remove("expanded")}getElement("#search-result").querySelectorAll("a").forEach((e=>e.setAttribute("tabindex",-1)));document.body.classList.remove("blur");u.classList.remove("open")}function v(){document.body.classList.add("blur");if(document.querySelector(".up")&&document.querySelector(".closed")){getElement(".navBtn").classList.add("expanded")}getElement("#search-result").removeAttribute("tabindex");u.classList.add("open");if(e===true){u.innerHTML="<div id='search-result'></div>";document.getElementById("search-result").innerHTML=""}else{p()}}function E(){let t=r.value.trim().toLowerCase();if(!t.length){r.placeholder=i;m();return}v();if(e===false){return}let n=t.split(/[-\s]+/);if(n.length>1){n.push(t)}let s=[];if(t.length>0){l.forEach((e=>{if(!e.title){return}let l=0,r=0,o=0;let i=e.title.trim();let a=i.toLowerCase();let c=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";let u=c.toLowerCase();let d=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");let p=[];let m=[];n.forEach((e=>{let t=h(e,a,false);let n=h(e,u,false);p=p.concat(t);m=m.concat(n);if(t.length>0||n.length>0){l++}if(t.length>0){r++}if(t.length>0||n.length>0){o++}}));if(p.length>0||m.length>0){[p,m].forEach((e=>{e.sort(((e,t)=>{if(t.position!==e.position){return t.position-e.position}return e.word.length-t.word.length}))}));let e=[];let n=[];if(p.length!==0){let n=f(0,i.length,p,t);e.push(n)}let a=parseInt(config.top_n_per_article,10);if(a>=0){n=n.slice(0,a)}let u="";if(e.length!==0){u+=`<a href="${d}" class="recent-post"><b class="search-result-title">${g(i,e[0])}</b>`}else{u+=`<a href="${d}" class="recent-post"><b class="search-result-title">${i}</b>`}if(m!==null&&m.length!==0){let e=m[m.length-1];let n=e.position;let l=e.word;let s=n-20;let r=n+80;if(s<0){s=0}if(r<n+l.length){r=n+l.length}if(r>c.length){r=c.length}let o=f(s,r,m,t);u+=`<p class="search-result">${g(c,o)}...</p>`}else{u+=`<p class="search-result">${c}...</p>`}u+="</a>";s.push({item:u,TextCount:l,TitleCount:r,ContentCount:o,id:s.length})}}))}u.scroll({top:0,left:0});let o=getElement("#search-result");if(s.length===0){o.innerHTML=`<div id="no-result"><p>${format(c,`<b>${r.value}</b>`)}</p></div>`}else{s.sort(((e,t)=>{if(e.TextCount!==t.TextCount){return t.TextCount-e.TextCount}else if(e.TitleCount!==t.TitleCount){return t.TitleCount-e.TitleCount}else if(e.ContentCount!==t.ContentCount){return t.ContentCount-e.ContentCount}return t.id-e.id}));let e="";s.forEach((t=>{e+=t.item}));o.innerHTML=e}if(typeof pjax!=="undefined"){pjax.refresh(o)}}r.addEventListener("keypress",(e=>{if(e.key===13){E()}}));let L=0;function T(){o.classList.add("search");o.classList.add("search-moving");clearTimeout(L);L=setTimeout((()=>o.classList.remove("search-moving")),600);header.closeAll();if(document.querySelector(".up")){getElement("main").style.pointerEvents="none"}r.placeholder=i;if(!e){if(!t){d()}n=true}}function C(){if(!o.classList.contains("search")){return}o.classList.remove("search");o.classList.add("search-moving");clearTimeout(L);L=setTimeout((()=>o.classList.remove("search-moving")),600);m();r.value="";r.placeholder=a;document.removeEventListener("mouseup",C);n=false;getElement("main").style.pointerEvents="";r.blur()}r.addEventListener("keyup",(()=>{o.classList.add("search");E()}));r.addEventListener("focus",(()=>{T()}));r.addEventListener("blur",(e=>{if(!e.relatedTarget||e.relatedTarget.parentElement!==getElement("#search-result")){C()}}));u.addEventListener("focusout",(e=>{if(!e.relatedTarget||e.relatedTarget!==r&&e.relatedTarget.parentElement!==getElement("#search-result")){C()}}));document.addEventListener("keyup",(e=>{if(e.key==="Escape"){C()}else if(e.key==="f"&&!["INPUT","TEXTAREA"].includes(e.target.tagName)){if(!document.querySelector(".up")){getElement(".navBtn").classList.remove("hide");header.open()}T();r.focus()}}));document.addEventListener("click",(e=>{if(e.target.tagName==="A"||e.target.parentElement.tagName==="A"){C()}}))})();